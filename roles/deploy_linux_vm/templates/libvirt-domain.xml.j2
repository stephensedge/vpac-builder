<domain type="kvm">
    <name>{{ vm_name }}</name>

    <!-- Memory -->
    <memory unit="MiB">{{ vm_memory }}</memory>
    <currentMemory unit="MiB">{{ vm_memory }}</currentMemory>

    <!-- vcpu -->
    <vcpu placement='static'>{{ vm_vcpus }}</vcpu>

    <os>
        <type arch="x86_64" machine="pc-q35-rhel9.7.0">hvm</type>
        <boot dev="hd"/>
    </os>

    <features>
        <acpi/>
        <apic/>
        <vmport state='off'/>
    </features>

    <cpu mode='host-passthrough' check='none'/>

    <clock offset="utc">
        <timer name="rtc" tickpolicy="catchup"/>
        <timer name="pit" tickpolicy="delay"/>
        <timer name="hpet" present="no"/>
    </clock>

    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <on_crash>destroy</on_crash>

    <devices>
        <emulator>/usr/libexec/qemu-kvm</emulator>

        <!-- Primary Disk -->
        <disk type='file' device='disk'>
            <driver name='qemu' type='qcow2' cache='none' io='native'/>
            <source file="{{ vm_disk_path }}"/>    
            <target dev='vda' bus='virtio'/>
        </disk>

        <!-- Optional devices to add -->
        {% if devices is defined and devices | length > 0 %}
        {% for device in devices %}
        <disk type='file' device='{{ device.type }}'>
            <driver name='qemu' type='raw'/>
            <source file='{{ libvirt_images_dir }}/{{ device.filename }}'/>
            <target dev='sda' bus='sata'/>
            <readonly />
        </disk>
        {% endfor %}
        {% endif %}

        <!-- Network -->
        <interface type='network'>
            <source network='default'/>
            <model type='virtio'/>
        </interface>

        <!-- Console -->
        <console type='pty'>
            <target type='serial' port='0'/>
        </console>

        <!-- Graphics (VNC) -->
        <graphics type='vnc' port='5900' autoport='yes' listen='0.0.0.0'/>

        <!-- Input -->
        <input type='tablet' bus='usb'/>
        <input type='keyboard' bus='ps2'/>

        <!-- Video -->
        <video>
            <model type='qxl'/>
        </video>

    </devices>
</domain>