---
# This task configures the image builder server for building customized RHEL 
# Images for vpac
- name: Run the osbuild setup_server role to configure imagebuilder host
  ansible.builtin.import_role:
    name: infra.osbuild.setup_server  
- name: Update imagebuilder sources for RT and NFV packages
  block:
  - name: Update imagebuilder sources for HA rpm packages
    ansible.builtin.tempfile:
      state: file
      suffix: toml
    register: highavailability
  - name: Update highavailability toml file
    ansible.builtin.copy:
      dest: "{{ highavailability.path }}"
      content: |
        id = "highavailability-os"
        name = "Highavailability OS packages"
        type = "yum-baseurl"
        url = "https://cdn.redhat.com/content/dist/rhel9/9/{{ ansible_architecture }}/highavailability/os/"
        check_gpg = true
        check_ssl = true
        system = false
        rhsm = true
      owner: root
      group: root
      mode: u=rw,g=r,o=r
  - name: Create a temp realtime-baseos.toml file
    ansible.builtin.tempfile:
      state: file
      suffix: toml
    register: realtime_baseos
  - name: Update realtime baseos toml file
    ansible.builtin.copy:
      dest: "{{ realtime_baseos.path }}"
      content: |
        id = "realtime-baseos"
        name = "Realtime baseos packages"
        type = "yum-baseurl"
        url = "https://cdn.redhat.com/content/dist/rhel9/9/{{ ansible_architecture }}/rt/os/"
        check_gpg = true
        check_ssl = true
        system = false
        rhsm = true
      owner: root
      group: root
      mode: u=rw,g=r,o=r 
  - name: Create a temp nfv-baseos toml file
    ansible.builtin.tempfile:
      state: file
      suffix: toml
    register: nfv_baseos
  - name: Update NFV baseos toml file
    ansible.builtin.copy:
      dest: "{{ nfv_baseos.path }}"
      content: |
        id = "nfv-baseos"
        name = "NFV baseos packages"
        type = "yum-baseurl"
        url = "https://cdn.redhat.com/content/dist/rhel9/9/{{ ansible_architecture }}/nfv/os/"
        check_gpg = true
        check_ssl = true
        system = false
        rhsm = true
      owner: root
      group: root
      mode: u=rw,g=r,o=r
  - name: Create a temp toml file for epel
    ansible.builtin.tempfile:
      state: file
      suffix: toml
    register: epel
  - name: update toml file
    ansible.builtin.copy:
      dest: "{{ epel.path }}"
      content: |
        id = "epel"
        name = "Extra Packages for Enterprise Linux"
        type = "yum-metalink"
        url = "https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=x86_64"
        check_gpg = true
        check_ssl = true
        system = false
        rhsm = false
        check_repogpg = false
        gpgkeys = ['''-----BEGIN PGP PUBLIC KEY BLOCK-----

        mQINBGE3mOsBEACsU+XwJWDJVkItBaugXhXIIkb9oe+7aadELuVo0kBmc3HXt/Yp
        CJW9hHEiGZ6z2jwgPqyJjZhCvcAWvgzKcvqE+9i0NItV1rzfxrBe2BtUtZmVcuE6
        2b+SPfxQ2Hr8llaawRjt8BCFX/ZzM4/1Qk+EzlfTcEcpkMf6wdO7kD6ulBk/tbsW
        DHX2lNcxszTf+XP9HXHWJlA2xBfP+Dk4gl4DnO2Y1xR0OSywE/QtvEbN5cY94ieu
        n7CBy29AleMhmbnx9pw3NyxcFIAsEZHJoU4ZW9ulAJ/ogttSyAWeacW7eJGW31/Z
        39cS+I4KXJgeGRI20RmpqfH0tuT+X5Da59YpjYxkbhSK3HYBVnNPhoJFUc2j5iKy
        XLgkapu1xRnEJhw05kr4LCbud0NTvfecqSqa+59kuVc+zWmfTnGTYc0PXZ6Oa3rK
        44UOmE6eAT5zd/ToleDO0VesN+EO7CXfRsm7HWGpABF5wNK3vIEF2uRr2VJMvgqS
        9eNwhJyOzoca4xFSwCkc6dACGGkV+CqhufdFBhmcAsUotSxe3zmrBjqA0B/nxIvH
        DVgOAMnVCe+Lmv8T0mFgqZSJdIUdKjnOLu/GRFhjDKIak4jeMBMTYpVnU+HhMHLq
        uDiZkNEvEEGhBQmZuI8J55F/a6UURnxUwT3piyi3Pmr2IFD7ahBxPzOBCQARAQAB
        tCdGZWRvcmEgKGVwZWw5KSA8ZXBlbEBmZWRvcmFwcm9qZWN0Lm9yZz6JAk4EEwEI
        ADgWIQT/itE0RZcQbs6BO5GKOHK/MihGfAUCYTeY6wIbDwULCQgHAgYVCgkICwIE
        FgIDAQIeAQIXgAAKCRCKOHK/MihGfFX/EACBPWv20+ttYu1A5WvtHJPzwbj0U4yF
        3zTQpBglQ2UfkRpYdipTlT3Ih6j5h2VmgRPtINCc/ZE28adrWpBoeFIS2YAKOCLC
        nZYtHl2nCoLq1U7FSttUGsZ/t8uGCBgnugTfnIYcmlP1jKKA6RJAclK89evDQX5n
        R9ZD+Cq3CBMlttvSTCht0qQVlwycedH8iWyYgP/mF0W35BIn7NuuZwWhgR00n/VG
        4nbKPOzTWbsP45awcmivdrS74P6mL84WfkghipdmcoyVb1B8ZP4Y/Ke0RXOnLhNe
        CfrXXvuW+Pvg2RTfwRDtehGQPAgXbmLmz2ZkV69RGIr54HJv84NDbqZovRTMr7gL
        9k3ciCzXCiYQgM8yAyGHV0KEhFSQ1HV7gMnt9UmxbxBE2pGU7vu3CwjYga5DpwU7
        w5wu1TmM5KgZtZvuWOTDnqDLf0cKoIbW8FeeCOn24elcj32bnQDuF9DPey1mqcvT
        /yEo/Ushyz6CVYxN8DGgcy2M9JOsnmjDx02h6qgWGWDuKgb9jZrvRedpAQCeemEd
        fhEs6ihqVxRFl16HxC4EVijybhAL76SsM2nbtIqW1apBQJQpXWtQwwdvgTVpdEtE
        r4ArVJYX5LrswnWEQMOelugUG6S3ZjMfcyOa/O0364iY73vyVgaYK+2XtT2usMux
        VL469Kj5m13T6w==
        =Mjs/
        -----END PGP PUBLIC KEY BLOCK-----''']
  - name: create temp toml file for codeready
    ansible.builtin.tempfile:
      state: file
      suffix: toml
    register: codeready
  - name: Update toml file
    ansible.builtin.copy:
      dest: "{{ codeready.path }}"
      content: |
        id = "rhel-9-crb"
        name = "RHEL 9 CodeReady Builder"
        type = "yum-baseurl"
        url = "https://cdn.redhat.com/content/dist/rhel9/9/x86_64/codeready-builder/os/"
        check_gpg = true
        check_ssl = true
        system = false
        rhsm = true
  - name: Add to imagebuilder sources
    ansible.builtin.command: "sudo composer-cli sources add {{ item }}"
    loop:
    - "{{ highavailability.path }}"
    - "{{ realtime_baseos.path }}"
    - "{{ nfv_baseos.path }}"
    - "{{ epel.path }}"
    - "{{ codeready.path }}"
